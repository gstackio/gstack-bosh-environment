#!/usr/bin/env bash

source "$BASE_DIR/lib/infra.inc.bash"
source "$BASE_DIR/lib/colors.inc.bash"

set -e

assert_terraform_version
assert_bbl_version


echo -e "\n${BLUE}Fetching ${BOLD}upstream base deployment manifests$RESET\n"

fetch_ubdms


echo -e "\n${BLUE}Running ${BOLD}bbl up$RESET to create infrastructure for the BOSH environment\n"

bbl_invoke up \
    --gcp-region "$(infra_var /region)" \
    --gcp-zone "$(infra_var /zone)" \
    --gcp-service-account-key "$BASE_DIR/base-env/conf/gcp-service-account.key.json" \
    --gcp-project-id "$(infra_var /project_id)" \
    --iaas gcp \
    --no-director

# Ensure restricted permissions for state files containing sensitive
# informations. Please not that 'bbl-state.json' must not be created before
# invoking `bbl up`.
restrict_permissions \
    "$BASE_DIR/state/base-env/bbl-state.json" \
    "$BASE_DIR/state/base-env/depl-creds.yml"

infra_bosh_ro_invoke interpolate > "$BASE_DIR/state/base-env/depl-manifest.yml"


echo -e "\n${BLUE}Running ${BOLD}bosh create-env$RESET to create the BOSH environment\n"

infra_bosh_rw_invoke create-env


alias-env
