#!/usr/bin/env bash

source "$BASE_DIR/lib/gbe/infra.inc.bash"
source "$BASE_DIR/lib/gbe/colors.inc.bash"

set -e

assert_terraform_version
assert_bbl_version

fetch_ubdms


infra_bosh_ro_invoke interpolate > "$BASE_DIR/state/base-env/depl-manifest.yml"


if [ ! -e "$BASE_DIR/state/base-env/depl-creds.yml" ]; then
    echo -e "\n${BLUE}Skipping ${BOLD}bosh delete-env$RESET, as the 'state/base-env/depl-creds.yml' file is absent\n"
else
    echo -e "\n${BLUE}Running ${BOLD}bosh delete-env$RESET to destroy the BOSH environment\n"
    infra_bosh_rw_invoke delete-env
    rm -vf "$BASE_DIR/state/base-env/depl-creds.yml"
fi


if [ ! -e "$BASE_DIR/state/base-env/jumpbox.key" ]; then
    echo -e "\n${BLUE}Skipping ${BOLD}SSH key removal$RESET, as it is absent\n"
else
    echo -e "\n${BLUE}Removing ${BOLD}SSH key$RESET from SSH Agent\n"
    ssh-keygen -y -f "$BASE_DIR/state/base-env/jumpbox.key" > "$BASE_DIR/state/base-env/jumpbox.key.pub"
    if ssh-add -L | grep -qF "$(cat "$BASE_DIR/state/base-env/jumpbox.key.pub")"; then
        ssh-add -d "$BASE_DIR/state/base-env/jumpbox.key.pub"
    fi
    rm -vf "$BASE_DIR/state/base-env/jumpbox.key" "$BASE_DIR/state/base-env/jumpbox.key.pub"
    ssh-keygen -f ~/.ssh/known_hosts -R "$(gbe ip)"
fi

if [ "x$1" == "x-k" ]; then
    echo -e "\n${BLUE}Skipping ${BOLD}bbl destroy$RESET, as per user request\n"
elif [ ! -e "$BASE_DIR/state/base-env/bbl-state.json" ]; then
    echo -e "\n${BLUE}Skipping ${BOLD}bbl destroy$RESET, as the 'state/bbl-state.json' file is absent\n"
else
    echo -e "\n${BLUE}Running ${BOLD}bbl destroy$RESET to destroy infrastructure for the BOSH environment\n"
    bbl_invoke destroy --no-confirm --skip-if-missing
fi
