#!/usr/bin/env bash

source "$BASE_DIR/lib/colors.inc.bash"


# Render the zone config
mkdir -p "$BASE_DIR/state/dns"
external_ip=$(jq -r .tfState "$BASE_DIR/state/base-env/bbl-state.json" \
                | jq -r .modules[0].outputs.external_ip.value)
dns_zone=$(bosh int "$BASE_DIR/base-env/conf/global-config.yml" --path /dns_zone)
dns_subdomain=$(bosh int "$BASE_DIR/base-env/conf/global-config.yml" --path /dns_subdomain)
sed -e "s/EXTERNAL_IP/$external_ip/g; s/DNS_ZONE/$dns_zone/g; s/DNS_SUBDOMAIN/$dns_subdomain/g;" \
    "$DNS_DIR/conf/zone-config-template.js" > "$BASE_DIR/state/dns/zone-config.js"


dnscontrol -creds "$DNS_DIR/conf/creds.json" -js "$BASE_DIR/state/dns/zone-config.js" preview
status=$?

if [ "$status" -eq 0 ]; then
    echo -e "\nIf the above is correct for you," \
        "then you can run '${BLUE}${BOLD}push${RESET}' now.\n"
fi
exit $status
