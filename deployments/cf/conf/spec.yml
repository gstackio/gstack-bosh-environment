---
subsys:
  name: cf
  type: bosh-deployment
  depends_on: [ traefik ]

input_resources:
  - name: cf-deployment
    type: git
    uri: https://github.com/cloudfoundry/cf-deployment.git
    version: v5.4.0
  - name: prometheus-boshrelease
    type: git
    uri: https://github.com/bosh-prometheus/prometheus-boshrelease.git
    version: v23.3.0


main_deployment_file: cf-deployment/cf-deployment.yml

operations_files:
  10_cf-deployment:
    # - operations/use-compiled-releases
    - operations/bosh-lite
    # operations/stop-skipping-tls-validation # to be enabled when using produciton certs
    - operations/rename-network-and-deployment
    - operations/enable-service-discovery
    - operations/override-app-domains # must appear after 'enable-service-discovery'
    - operations/backup-and-restore/enable-backup-restore
    - operations/bits-service/use-bits-service

    # - operations/use-pxc
    # - operations/migrate-cf-mysql-to-pxc
    # - operations/use-pxc-for-nfs-volume-service

    # - operations/use-external-blobstore

    # - operations/enable-nfs-volume-service
    # - operations/experimental/enable-nfs-volume-service-credhub
    # - operations/enable-nfs-ldap
    # - operations/backup-and-restore/enable-backup-restore-nfs-broker


    # # Add 'cc_deployment_updater' job to 'scheduler' vm, which enables zero
    # # downtime app deployments.
    # - operations/experimental/add-deployment-updater

    # Add the cflinuxfs3 stack and buildpacks.
    - operations/experimental/add-cflinuxfs3

    # # Enables container proxy on the Diego Cell 'rep' and configures gorouter
    # # to opt into TLS-enabled connections to the backend.
    # - operations/experimental/enable-routing-integrity

    # # Improve routability in the face of cell presence loss
    # - operations/experimental/enable-suspect-actual-lrp-generation

    # # Enable rootless garden-runc containers.
    # - operations/experimental/rootless-containers

    # # Configure Garden to create OCI compatible images.
    # - operations/experimental/enable-oci-phase-1

    # # Configure Cloud Controller to use Log Cache instead of Traffic
    # # Controller for app container metrics.
    # - operations/experimental/use-logcache-for-cloud-controller-app-stats

    # # Enables TLS on the database job, and secures all client database
    # # connections.
    # - operations/experimental/enable-mysql-tls

    # - operations/experimental/perm-service # Requires 'enable-mysql-tls'
    # # - operations/experimental/perm-service-with-tcp-routing
    # - operations/experimental/perm-service-with-pxc-release


    # Add the Prometheus node exporter and Loggregator Prom Scraper to addons.
    # This puts infrastructure metrics into Loggregator's metric stream.
    # - operations/experimental/infrastructure-metrics

    # Configures the default 'vm_strategy' to be 'create-swap-delete'.
    # - operations/experimental/use-create-swap-delete-vm-strategy

    # Allows traffic from app containers to internal networks. Required to
    # allow applications to communicate with the running CredHub in non-
    # assisted mode.
    # - operations/experimental/enable-traffic-to-internal-networks.

  20_prometheus-boshrelease:
    - manifests/operators/cf/add-prometheus-uaa-clients
    - manifests/operators/cf/add-grafana-uaa-clients
  30_local:
    - pin-stemcell
    # - set-mysql-version
    - set-routing-version
    - expose-admin-user-as-link
    # - cassandra-support # only kept as an example ASG
    # - database-pxc-bosh-lite
    - database-mysql-bosh-lite
    - log-cache-bosh-lite
    - scale-disks
    - tls-from-gorouters-to-backends
    - missing-network-renames


deployment_vars:
  deployment_name: easyfoundry-cf


  # User-facing settings

  system_domain: sys.easyfoundry.prototyp.it
  app_domains:
    - name: &apps_domain apps.easyfoundry.prototyp.it
    # NOTE: the 'apps.internal' domain below is normally brought by
    # 'operations/enable-service-discovery', but is actually overridden by
    # 'operations/override-app-domains'.
    - name: apps.internal
      internal: true
  smoke_test_app_domain: *apps_domain


  # Tweaks

  # This setting depends on the total RAM size allocated to the Garden VM.
  # Example: 2% of the total 25GB RAM means 500MB max.
  # See also: the 'scale-vm-size.yml' ops file for the Garden VM.
  log_cache_memory_limit_percent: 2


  # Versions

  stemcell_name: bosh-warden-boshlite-ubuntu-xenial-go_agent
  stemcell_os: ubuntu-xenial
  stemcell_version: "250.38"
  stemcell_sha1: 92238f2c47e390be7779ca2b18fb898f4bdb40de


  # Reference declarations

  bpm_version: "0.13.0"
  bpm_sha1: 4b6ebfdaa467c04855528172b099e565d679e0f5

  routing_version: "0.182.0"
  routing_sha1: 6e341a527a0dd2c920b54dea82156ae9bc0b29eb

  cf_mysql_version: "36.15.0"
  cf_mysql_sha1: 0764d9d6aae7cefd10019437ed83e7715e614633

  credhub_version: "2.1.1"
  credhub_sha1:    dd0b607d855a8d23e6fd52b990573570e68bbbf6

  uaa_version: "63.0"
  uaa_sha1: 1ad8813665e94d2a3defda3304083af57c151541

  os_conf_version: "20.0.0"
  os_conf_sha1: a60187f038d45e2886db9df82b72a9ab5fdcc49d

  bosh_dns_aliases_version: "0.0.3"
  bosh_dns_aliases_sha1: b0d0a0350ed87f1ded58b2ebb469acea0e026ccc

  network_name: default # injected in cloud-config


imported_vars:
  - subsys: cf
    imports:
      - name: grafana_redirect_uri
        from: depl-vars
        value: https://uaa.((system_domain))/login
