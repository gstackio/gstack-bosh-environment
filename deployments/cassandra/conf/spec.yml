---
subsys:
  name: cassandra
  type: bosh-deployment
  deploy_after: shield-v7 # which itself is to "deploy_after: cf"

input_resources:
  - name: cassandra-boshrelease
    type: git
    uri: https://github.com/orange-cloudfoundry/cassandra-cf-service-boshrelease.git
    version: bosh-lite # v4 with fixes, as of Dec 19th, 2017


main_deployment_file: ./conf/cassandra-deployment.yml


operations_files:
  local:
    - set-versions
    - cf-integration
    - routing
    - shield-integration


deployment_vars:
  deployment_name: easyfoundry-cassandra


  # User-facing settings

  cassandra_domain: cassandra.easyfoundry.prototyp.it

  # Normally, a minimum of 6G heap size is necessary. But here we miss some GB
  # when deploying all the rest of Easy Foundry on a 32GB Bosh-Lite VM. So we
  # reduce this to 4G.
  max_heap_size: 4G


  # Versions

  cassandra_version: "4+dev.1"

  broker_registrar_version: "3.4.0"
  broker_registrar_sha1: "d44d9af8fd06ecf6d50004c9bfd5516a6e482201"

  routing_version: "0.168.0"
  routing_sha1: 885321f95b530c4a5b8515c72155229cba26c449

  stemcell_name: bosh-warden-boshlite-ubuntu-trusty-go_agent
  stemcell_version: "3468.11"
  stemcell_sha1: 74592d4c2b7f2aebacd767112dd0ef28b028532b


  # Reference declarations

  network_name: cassandra-network # injected in cloud-config and runtime-config


imported_vars:
  - subsys: cf
    imports:
      - name: cf_deployment_name
        from: depl-vars
        path: /deployment_name

      - name: cf_api_url
        from: depl-manifest
        path: /instance_groups/name=api/jobs/name=cf-admin-user/properties/api_url

      - name: cf_skip_ssl_validation
        from: depl-manifest
        path: /instance_groups/name=smoke-tests/jobs/name=smoke_tests/properties/smoke_tests/skip_ssl_validation

      - name: cf_admin_username
        from: depl-manifest
        path: /instance_groups/name=api/jobs/name=cf-admin-user/properties/admin_username

      - name: cf_admin_password
        from: depl-creds
        path: /cf_admin_password

      - name: cf_app_domain
        from: depl-vars
        path: /system_domain

  - subsys: shield-v7
    imports:
      - name: shield_deployment_name
        from: depl-vars
        path: /deployment_name
