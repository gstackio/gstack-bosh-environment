#!/usr/bin/env bash

source "$BASE_DIR/lib/gbe/common.inc.bash"
assert runtime-config "$RUNTIME_CONFIG_DIR"

DEPL_DIR=$RUNTIME_CONFIG_DIR # Shim: 'fetch_ubdms' is expecting this
fetch_ubdms

source "$RUNTIME_CONFIG_DIR/conf/operations-layout.inc.bash"

DEPL_DIR=$RUNTIME_CONFIG_DIR # Shim: 'build_operations_arguments' is expecting this
build_operations_arguments

RUNTIME_CONFIG_FILE=$MAIN_DEPLOYMENT_FILE # Shim
bosh interpolate "$RUNTIME_CONFIG_FILE" \
    "${operations_arguments[@]}" \
    --vars-file "$RUNTIME_CONFIG_DIR/conf/depl-vars.yml" \
    > "$(state_dir)/runtime-config.yml"

if [ ! -s "$(state_dir)/runtime-config.yml" ]; then
    echo "Cloud config file is empty. ${BLUE}Skipping$RESET update."
    exit 0
fi
bosh update-runtime-config "$(state_dir)/runtime-config.yml" "$@"
