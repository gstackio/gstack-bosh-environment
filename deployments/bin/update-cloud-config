#!/usr/bin/env bash

source "$BASE_DIR/lib/gbe/common.inc.bash"
assert cloud-config "$CLOUD_CONFIG_DIR"

DEPL_DIR=$CLOUD_CONFIG_DIR # Shim: 'fetch_ubdms' is expecting this
fetch_ubdms

source "$CLOUD_CONFIG_DIR/conf/operations-layout.inc.bash"

DEPL_DIR=$CLOUD_CONFIG_DIR # Shim: 'build_operations_arguments' is expecting this
build_operations_arguments

BASE_CLOUD_CONFIG_FILE=$MAIN_DEPLOYMENT_FILE # Shim
bosh interpolate "$BASE_CLOUD_CONFIG_FILE" \
    "${operations_arguments[@]}" \
    --vars-file "$CLOUD_CONFIG_DIR/conf/depl-vars.yml" \
    > "$(state_dir)/cloud-config.yml"

if [ ! -s "$(state_dir)/cloud-config.yml" ]; then
    echo "Cloud config file is empty. ${BLUE}Skipping$RESET update."
    exit 0
fi
bosh update-cloud-config "$(state_dir)/cloud-config.yml" "$@"
