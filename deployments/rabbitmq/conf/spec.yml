---
subsys:
  name: rabbitmq
  type: bosh-deployment
  depends_on: [ cf ]

input_resources:
  - name: rabbitmq-boshrelease
    type: git
    uri: https://github.com/pivotal-cf/cf-rabbitmq-release.git
    version: v265.0.0
  - name: rabbitmq-broker-boshrelease
    type: git
    uri: https://github.com/pivotal-cf/cf-rabbitmq-multitenant-broker-release.git
    version: v51.0.0
  - name: rabbitmq-smoke-tests-boshrelease
    type: git
    uri: https://github.com/pivotal-cf/cf-rabbitmq-smoke-tests-release.git
    version: v29.0.0


main_deployment_file: rabbitmq-boshrelease/manifests/cf-rabbitmq-template.yml


operations_files:
  10_rabbitmq-broker-boshrelease:
    - manifests/enable-tls
  20_local:
    - rename-deployment
    - rename-network
    - pin-stemcell
    - pin-versions
    - fix-missing-variables
    - scale-for-bosh-lite
    - add-broker
    - customize-routing
    - tweak-tls
    - customize-plugins


deployment_vars:
  deployment_name: easyfoundry-rabbitmq


  # User-facing settings

  rabbitmq-management-hostname: rabbitmq    # Exposes the RMQ UI at https://rabbitmq.<cf-system-domain>
  rabbitmq-broker-hostname: rabbitmq-broker # Exposes the RMQ broker at https://rabbitmq-broker.<cf-system-domain>

  product-name: rabbitmq # as displayed in 'cf marketplace'

  tls_versions: [ "tlsv1.2" ] # [ "tlsv1.2", "tlsv1.1" ] # TLS protocol versions to support


  # Customizations

  persistent_disk_type: 1GB
  disk_alarm_threshold: 100_000_000 # 100MB # in Bosh-Lite, we can't use the default "{mem_relative,0.4}", nor the Pivotal-recommended "{mem_relative,1.5}"
  cluster-partition-handling-strategy: autoheal # Recommended for BOSH-Lite instead of the default 'pause_minority'
  rabbitmq_instances: 2
  haproxy-instances: 1


  # Versions

  rabbitmq_version: "3.7"

  rabbitmq_release_version: "265.0.0"
  rabbitmq_release_sha1: 04f5ce7f98922f03959883f7a1e279012b1a58e0

  rabbitmq_broker_version: "51.0.0"
  rabbitmq_broker_sha1: f3f8c2dafe46b7906ef79ca5fe005fef1c45fb69

  rabbitmq_smoke_tests_version: "29.0.0"
  rabbitmq_smoke_tests_sha1: 5920aea04179c42fe8cf1dcbc553ad2eb54732e7

  cf_cli_release_version: "1.14.0"
  cf_cli_release_sha1: 0c0ea67ef3a4d0622918a1a1bc5a5fa95e7426cf

  broker_registrar_version: "3.5.1"
  broker_registrar_sha1: 9250e45ed194105e3c613bb2f195ade85f4cbe32

  # bpm_version:  # imported below
  # bpm_sha1:     # imported below

  # routing_version:  # imported below
  # routing_sha1:     # imported below

  # stemcell_os:      # imported below
  # stemcell_version: # imported below
  # stemcell_sha1:    # imported below

  # # Stemcell downgrade, sometimes necessary:
  # stemcell_name: bosh-warden-boshlite-ubuntu-xenial-go_agent
  # stemcell_os: ubuntu-xenial
  # stemcell_version: "170.51"
  # stemcell_sha1: 7a1b2d4e560e16fa8698f3de3751f30735b1a63c


  # Reference declarations

  network_name: default # injected in runtime-config


  # Plumbery

  rabbitmq-management-username: admin # used by human ops when connecting to rabbit (optional, set this to ~ in order to disable)
  rabbitmq-broker-username: broker # used by broker to access rabbit
  multitenant-rabbitmq-broker-username: capi # used by CC when connecting to the broker

  rabbitmq-broker-uuid: f56d4ca2-ac6c-45d3-82aa-a3651956ceb7
  rabbitmq-broker-plan-uuid: e1e425d1-b64c-4620-9087-b274f0168b20


imported_vars:
  - subsys: cf
    imports:

      - name: bpm_version
        from: depl-vars
        path: /bpm_version
      - name: bpm_sha1
        from: depl-vars
        path: /bpm_sha1

      - name: routing_version
        from: depl-vars
        path: /routing_version
      - name: routing_sha1
        from: depl-vars
        path: /routing_sha1

      - name: stemcell_os
        from: depl-vars
        path: /stemcell_os
      - name: stemcell_version
        from: depl-vars
        path: /stemcell_version
      - name: stemcell_sha1
        from: depl-vars
        path: /stemcell_sha1

      # CF routing plumbing

      - name: routing_deployment_name
        from: depl-vars
        path: /deployment_name

      # CF-RabbitMQ deployment plumbery

      - name: system-domain
        from: depl-vars
        path: /system_domain

      # Broker plumbery

      - name: cf_deployment_name
        from: depl-vars
        path: /deployment_name

      - name: cf_skip_ssl_validation
        from: depl-manifest
        path: /instance_groups/name=smoke-tests/jobs/name=smoke_tests/properties/smoke_tests/skip_ssl_validation

      - name: cf-admin-username
        from: depl-manifest
        path: /instance_groups/name=api/jobs/name=cf-admin-user/properties/admin_username

      - name: cf-admin-password
        from: depl-creds
        path: /cf_admin_password

      - name: cf_system_domain
        from: depl-vars
        path: /system_domain
